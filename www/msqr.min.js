/*
	marching-squares ver 0.1.0 alpha

	(c) 2016 K3N / Epistemex
	www.epistemex.com
	MIT License
*/
function MSQR(v,r){r=r||{};var g;if(v instanceof CanvasRenderingContext2D){g=v}else{if(v instanceof HTMLCanvasElement){g=v.getContext("2d")}else{if(v instanceof HTMLImageElement||v instanceof HTMLVideoElement){g=o(v)}else{throw"Invalid source."}}}var A=g.canvas.width,n=g.canvas.height,k=r.x||0,l=r.y||0,j=r.width||A,f=r.height||n,e,u=[],t,d=Math.max(1,r.bleed||5),q=Math.max(1,r.maxShapes||1),b=Math.max(0,Math.min(254,r.alpha||0)),s=r.padding||0,y=Math.max(0,r.tolerance||0),m=!!r.align,a=r.alignWeight||0.95,i,p;if(k<0||l<0||k>=A||l>=n||j<1||f<1||k+j>A||l+f>n){return[]}if(q>1||s){e=g.getImageData(0,0,A,n);g.save();g.setTransform(1,0,0,1,0,0);g.globalCompositeOperation="source-over";g.fillStyle=g.strokeStyle="#000";g.globalAlpha=1;g.shadowColor="rgba(0,0,0,0)";if(s){i=o(g.canvas);p=s>5?16:8;if(s<0){g.globalCompositeOperation="destination-in"}s=Math.min(10,Math.abs(s));for(var c=0,x=Math.PI*2/p;c<6.28;c+=x){g.drawImage(i.canvas,s*Math.cos(c),s*Math.sin(c))}}do{t=z();if(t.length){u.push(t);g.beginPath();t.forEach(function(h){g.lineTo(h.x,h.y,1,1)});g.globalCompositeOperation="destination-out";g.lineWidth=d;g.closePath();g.fill();g.stroke()}}while(t.length&&--q);g.putImageData(e,0,0);g.restore();return u}else{u.push(z())}return u;function z(){var I=[],w,H,G,F,Q,R,O,P,L=-1,M,J=9,N=new Uint8Array([9,0,3,3,2,0,9,3,1,9,1,1,2,0,2,9]);w=g.getImageData(k,l,j,f).data;G=w.length;H=new Uint8Array(j*f);for(F=3;F<G;F+=4){if(w[F]>b){H[F>>2]=1;if(L<0){L=F>>2}}}Q=O=(L%j)|0;R=P=(L/j)|0;if(O>-1){do{M=D(Q,R);if(M===0){R--}else{if(M===1){R++}else{if(M===2){Q--}else{if(M===3){Q++}}}}if(M!==J){I.push({x:Q+k,y:R+l});J=M}}while(Q!==O||R!==P);if(y){I=K(I,y)}if(m&&!s){I=h(I,a)}}function E(S,T){return(S>-1&&T>-1&&S<j&&T<f)?H[T*j+S]:0}function D(T,U){var S=0|0;if(E(T-1,U-1)){S|=1}if(E(T,U-1)){S|=2}if(E(T-1,U)){S|=4}if(E(T,U)){S|=8}if(S===6){return J===0?2:3}else{if(S===9){return J===3?0:1}else{return N[S]}}}function K(ad,U){var ab=ad.length-1;if(ab<2){return ad}var W=ad[0],ac=ad[ab],V=U*U,X,Y=-1,S,T=0,Z,aa,ae,af;for(X=1;X<ab;X++){S=C(ad[X],W,ac);if(S>T){T=S;Y=X}}if(T>V){Z=ad.slice(0,Y+1);aa=ad.slice(Y);ae=K(Z,U);af=K(aa,U);return ae.slice(0,ae.length-1).concat(af)}else{return[W,ac]}}function C(V,S,T){var U=B(S,T),W;if(!U){return 0}W=((V.x-S.x)*(T.x-S.x)+(V.y-S.y)*(T.y-S.y))/U;if(W<0){return B(V,S)}else{if(W>1){return B(V,T)}else{return B(V,{x:S.x+W*(T.x-S.x),y:S.y+W*(T.y-S.y)})}}}function B(U,V){var S=U.x-V.x,T=U.y-V.y;return S*S+T*T}function h(U,V){var S=new Int8Array([1,-1,-1,1]),T=new Int8Array([1,1,-1,-1]);U.forEach(function(Z){Z.x=Math.round(Z.x);Z.y=Math.round(Z.y);for(var Y=0,aa,ab,W,X;Y<4;Y++){W=S[Y];X=T[Y];aa=Z.x+(W<<1);ab=Z.y+(X<<1);if(aa>k&&ab>l&&aa<j-1&&ab<f-1){if(!E(aa,ab)){aa-=W;ab-=X;if(E(aa,ab)){Z.x+=W*V;Z.y+=X*V}}}}});return U}return I}function o(B){var h=document.createElement("canvas"),w;h.width=B.naturalWidth||B.videoWidth||B.width;h.height=B.naturalHeight||B.videoHeight||B.height;w=h.getContext("2d");w.drawImage(B,0,0);return w}}MSQR.getBounds=function(g){var e=9999999,f=9999999,c=-9999999,d=-9999999,a,b=g.length;for(a=0;a<b;a++){if(g[a].x>c){c=g[a].x}if(g[a].x<e){e=g[a].x}if(g[a].y>d){d=g[a].y}if(g[a].y<f){f=g[a].y}}return{x:e|0,y:f|0,width:Math.ceil(c-e),height:Math.ceil(d-f)}};if(typeof exports!=="undefined"){exports.MSQR=MSQR};