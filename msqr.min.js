/*
	MSQR (marching-squares) ver 0.2.0 alpha
	(c) 2016 K3N / Epistemex
	www.epistemex.com
	MIT License
*/
function MSQR(B,u){u=u||{};var g;if(B instanceof CanvasRenderingContext2D){g=B}else{if(B instanceof HTMLCanvasElement){g=B.getContext("2d")}else{if(B instanceof HTMLImageElement||B instanceof HTMLVideoElement){g=q(B)}else{throw"Invalid source."}}}var F=g.canvas.width,o=g.canvas.height,l=u.x||0,m=u.y||0,k=u.width||F,f=u.height||o,e,y=[],x,s=3,d=Math.max(1,u.bleed||5),t=Math.max(1,u.maxShapes||1),b=Math.max(0,Math.min(254,u.alpha||0)),v=u.padding||0,D=Math.max(0,u.tolerance||0),n=!!u.align,a=u.alignWeight||0.95,A=!!u.path2D,j,r;if(l<0||m<0||l>=F||m>=o||k<1||f<1||l+k>F||m+f>o){return[]}if(t>1||v){e=g.getImageData(0,0,F,o);g.save();g.setTransform(1,0,0,1,0,0);g.globalCompositeOperation="source-over";g.fillStyle=g.strokeStyle="#000";g.globalAlpha=1;g.shadowColor="rgba(0,0,0,0)";if(v){j=q(g.canvas);r=v<0?4:(v>5?16:8);if(v<0){g.globalCompositeOperation="destination-in"}v=Math.min(10,Math.abs(v));for(var c=0,C=Math.PI*2/r;c<6.28;c+=C){g.drawImage(j.canvas,v*Math.cos(c),v*Math.sin(c))}}do{x=E();if(x.length){y.push(A?z(x):x);g.beginPath();var p=x.length-1;while(p--){g.lineTo(x[p].x,x[p].y)}g.globalCompositeOperation="destination-out";g.lineWidth=d;g.closePath();g.fill();g.stroke()}}while(x.length&&--t);g.putImageData(e,0,0);g.restore();return y}else{x=E();y.push(A?z(x):x)}return y;function E(){var M=[],w,L,K,U,V,S,T,P=-1,Q,N=9,R=[9,0,3,3,2,0,9,3,1,9,1,1,2,0,2,9];w=new Uint32Array(g.getImageData(l,m,k,f).data.buffer);L=w.length;for(K=s;K<L;K++){if((w[K]>>>24)>b){P=s=K;break}}U=S=(P%k)|0;V=T=(P/k)|0;if(S>-1){do{Q=I(U,V);if(Q===0){V--}else{if(Q===1){V++}else{if(Q===2){U--}else{if(Q===3){U++}}}}if(Q!==N){M.push({x:U+l,y:V+m});N=Q}}while(U!==S||V!==T);if(D){M=O(M,D)}if(n&&!v){M=h(M,a)}}function J(i,W){return(i>=0&&W>=0&&i<k&&W<f)?(w[W*k+i]>>>24)>b:0}function I(W,X){var i=0|0;if(J(W-1,X-1)){i|=1}if(J(W,X-1)){i|=2}if(J(W-1,X)){i|=4}if(J(W,X)){i|=8}if(i===6){return N===0?2:3}else{if(i===9){return N===3?0:1}else{return R[i]}}}function O(ah,Y){var af=ah.length-1;if(af<2){return ah}var aa=ah[0],ag=ah[af],Z=Y*Y,ab,ac=-1,W,X=0,ad,ae,ai,aj;for(ab=1;ab<af;ab++){W=H(ah[ab],aa,ag);if(W>X){X=W;ac=ab}}if(X>Z){ad=ah.slice(0,ac+1);ae=ah.slice(ac);ai=O(ad,Y);aj=O(ae,Y);return ai.slice(0,ai.length-1).concat(aj)}else{return[aa,ag]}}function H(Y,i,W){var X=G(i,W),Z;if(!X){return 0}Z=((Y.x-i.x)*(W.x-i.x)+(Y.y-i.y)*(W.y-i.y))/X;if(Z<0){return G(Y,i)}else{if(Z>1){return G(Y,W)}else{return G(Y,{x:i.x+Z*(W.x-i.x),y:i.y+Z*(W.y-i.y)})}}}function G(X,Y){var i=X.x-Y.x,W=X.y-Y.y;return i*i+W*W}function h(X,Y){var i=new Int8Array([1,-1,-1,1]),W=new Int8Array([1,1,-1,-1]);X.forEach(function(ac){ac.x=Math.round(ac.x);ac.y=Math.round(ac.y);for(var ab=0,ad,ae,Z,aa;ab<4;ab++){Z=i[ab];aa=W[ab];ad=ac.x+(Z<<1);ae=ac.y+(aa<<1);if(ad>l&&ae>m&&ad<k-1&&ae<f-1){if(!J(ad,ae)){ad-=Z;ae-=aa;if(J(ad,ae)){ac.x+=Z*Y;ac.y+=aa*Y}}}}});return X}return M}function q(w){var h=document.createElement("canvas"),i;h.width=w.naturalWidth||w.videoWidth||w.width;h.height=w.naturalHeight||w.videoHeight||w.height;i=h.getContext("2d");i.drawImage(w,0,0);return i}function z(H){var w=new Path2D(),h,G;w.moveTo(H[0].x,H[0].y);for(h=1;G=H[h++];){w.lineTo(G.x,G.y)}w.closePath();return w}}MSQR.getBounds=function(g){var e=9999999,f=9999999,c=-9999999,d=-9999999,a,b=g.length;for(a=0;a<b;a++){if(g[a].x>c){c=g[a].x}if(g[a].x<e){e=g[a].x}if(g[a].y>d){d=g[a].y}if(g[a].y<f){f=g[a].y}}return{x:e|0,y:f|0,width:Math.ceil(c-e),height:Math.ceil(d-f)}};if(typeof exports!=="undefined"){exports.MSQR=MSQR};